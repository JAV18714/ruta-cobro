<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruta de Cobro - Droguer√≠a Social</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-180x180.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ruta Cobro">
    <meta name="theme-color" content="#4a1fa0">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #4a1fa0 0%, #6b3fa0 100%); color: white; padding: 20px; text-align: center; }
        .header img { width: 120px; height: 120px; border-radius: 15px; margin-bottom: 10px; }
        .header h1 { font-size: 1.3em; margin-bottom: 5px; color: #ffd700; }
        .header p { opacity: 0.9; font-size: 0.9em; }
        .asesor-name { background: linear-gradient(135deg, #ffd700 0%, #ffb800 100%); color: #4a1fa0; padding: 12px; text-align: center; font-weight: 700; font-size: 1.1em; }
        .day-check { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; margin: 20px; border-radius: 10px; text-align: center; }
        .form-content { padding: 25px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2d3436; font-size: 0.95em; }
        .form-group label .required { color: #e74c3c; margin-left: 3px; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px 15px; border: 2px solid #dfe6e9; border-radius: 10px; font-size: 1em; }
        .form-group input:focus, .form-group textarea:focus { border-color: #6b3fa0; outline: none; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-group input:disabled { background: #e9ecef; color: #495057; cursor: not-allowed; }
        .info-box { background: #e8f4fd; border: 1px solid #bee5eb; border-radius: 10px; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
        .info-box .label { font-size: 0.85em; color: #636e72; }
        .info-box .value { font-weight: 600; color: #2d3436; font-size: 1.1em; }
        .photo-upload { position: relative; border: 2px dashed #dfe6e9; border-radius: 10px; padding: 30px; text-align: center; cursor: pointer; background: #f8f9fa; }
        .photo-upload input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .photo-upload .icon { font-size: 3em; margin-bottom: 10px; }
        .photo-upload p { color: #636e72; font-size: 0.9em; }
        .photo-preview { max-width: 100%; max-height: 200px; border-radius: 10px; margin-top: 10px; display: none; }
        .gps-status { display: flex; align-items: center; gap: 10px; padding: 12px 15px; background: #f8f9fa; border-radius: 10px; font-size: 0.9em; }
        .gps-status.loading { color: #f39c12; }
        .gps-status.success { color: #27ae60; background: #d5f4e6; }
        .gps-status.error { color: #e74c3c; background: #fdeaea; }
        .btn-submit { width: 100%; padding: 15px; background: linear-gradient(135deg, #4a1fa0 0%, #6b3fa0 100%); color: #ffd700; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn-submit:disabled { background: #bdc3c7; cursor: not-allowed; }
        .success-message { display: none; text-align: center; padding: 40px; }
        .success-message .checkmark { font-size: 4em; color: #27ae60; margin-bottom: 20px; }
        .blocked-message { display: none; text-align: center; padding: 40px; }
        .blocked-message .icon { font-size: 4em; margin-bottom: 20px; }
        .blocked-message h2 { color: #e74c3c; margin-bottom: 10px; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000; }
        .loading-content { background: white; padding: 40px; border-radius: 20px; text-align: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #6b3fa0; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .datetime-row { display: flex; gap: 10px; }
        .datetime-row .info-box { flex: 1; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay"><div class="loading-content"><div class="spinner"></div><p>Enviando registro...</p></div></div>
    <div class="container">
        <div class="header">
            <img src="icon-192x192.png" alt="Ruta de Cobro">
            <h1>RUTA DE COBRO</h1>
            <p>Droguer√≠a Social - Solo S√°bados</p>
        </div>
        <div class="asesor-name">üë§ JHON CRISTOBAL AYALA MONTES</div>
        <div class="blocked-message" id="blockedMessage">
            <div class="icon">üö´</div>
            <h2>Formulario no disponible</h2>
            <p>Este formulario solo est√° habilitado los d√≠as <strong>S√ÅBADOS</strong>.</p>
            <p style="margin-top: 15px;">Hoy es: <span id="currentDay"></span></p>
        </div>
        <div id="formSection" style="display: none;">
            <div class="day-check">‚úÖ Formulario habilitado</div>
            <form id="rutaCobroForm" class="form-content">
                <!-- Fecha y Hora autom√°ticas (no editables) -->
                <div class="form-group">
                    <label>üìÖ Fecha y Hora del Registro</label>
                    <div class="datetime-row">
                        <div class="info-box">
                            <div>
                                <div class="label">Fecha</div>
                                <div class="value" id="fechaDisplay">--</div>
                            </div>
                        </div>
                        <div class="info-box">
                            <div>
                                <div class="label">Hora</div>
                                <div class="value" id="horaDisplay">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group"><label>Empresa / Cliente <span class="required">*</span></label><input type="text" id="empresa" required placeholder="Nombre de la empresa"></div>
                <div class="form-group"><label>Foto de evidencia <span class="required">*</span></label><div class="photo-upload"><div class="icon">üì∑</div><p>Toca para tomar foto</p><input type="file" id="foto" accept="image/*" capture="environment" required></div><img id="photoPreview" class="photo-preview"><p id="photoStatus" style="font-size:0.8em;color:#636e72;margin-top:5px;"></p></div>
                <div class="form-group"><label>Observaci√≥n <span class="required">*</span></label><textarea id="observacion" required placeholder="Describe la visita"></textarea></div>
                <div class="form-group"><label>Contacto del cliente <span class="required">*</span></label><input type="tel" id="contacto" required placeholder="Tel√©fono"></div>
                <div class="form-group"><label>üìç Ubicaci√≥n GPS <span class="required">*</span></label><div class="gps-status loading" id="gpsStatus"><span>üîÑ</span><span>Obteniendo ubicaci√≥n...</span></div></div>
                <button type="submit" class="btn-submit" id="btnSubmit">‚úÖ Enviar Registro</button>
            </form>
        </div>
        <div class="success-message" id="successMessage"><div class="checkmark">‚úÖ</div><h2>¬°Registro Enviado!</h2><p>Tu ruta de cobro ha sido registrada.</p><button class="btn-submit" style="margin-top:20px;" onclick="nuevoRegistro()">‚ûï Nuevo Registro</button></div>
    </div>
    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwPYu83wOV9C52xVO4yw-po4dGIwmb2v39FH1SJPloZ4-h6zBzJdluujFq6k0rlc6Rz/exec';
        const NOMBRE_ASESOR = 'JHON CRISTOBAL AYALA MONTES';
        let ubicacionObtenida = false, latitud = '', longitud = '', precisionGPS = '', fotoBase64 = '';
        
        function actualizarReloj() {
            const ahora = new Date();
            document.getElementById('fechaDisplay').textContent = ahora.toLocaleDateString('es-CO');
            document.getElementById('horaDisplay').textContent = ahora.toLocaleTimeString('es-CO', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
        }
        
        function verificarDia() {
            const hoy = new Date(), diaSemana = hoy.getDay();
            const dias = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            document.getElementById('currentDay').textContent = dias[diaSemana] + ', ' + hoy.toLocaleDateString('es-CO');
            const esSabado = true;
            if (esSabado) { document.getElementById('formSection').style.display = 'block'; document.getElementById('blockedMessage').style.display = 'none'; inicializarFormulario(); }
            else { document.getElementById('formSection').style.display = 'none'; document.getElementById('blockedMessage').style.display = 'block'; }
        }
        
        function inicializarFormulario() {
            actualizarReloj();
            setInterval(actualizarReloj, 1000);
            obtenerUbicacion();
        }
        
        function obtenerUbicacion() {
            const statusDiv = document.getElementById('gpsStatus');
            statusDiv.className = 'gps-status loading';
            statusDiv.innerHTML = '<span>üîÑ</span><span>Obteniendo ubicaci√≥n...</span>';
            if (!navigator.geolocation) { statusDiv.className = 'gps-status error'; statusDiv.innerHTML = '<span>‚ùå</span><span>GPS no soportado</span>'; return; }
            navigator.geolocation.getCurrentPosition(
                function(pos) { latitud = pos.coords.latitude; longitud = pos.coords.longitude; precisionGPS = pos.coords.accuracy; statusDiv.className = 'gps-status success'; statusDiv.innerHTML = '<span>‚úÖ</span><span>Ubicaci√≥n obtenida</span>'; ubicacionObtenida = true; },
                function() { statusDiv.className = 'gps-status error'; statusDiv.innerHTML = '<span>‚ùå</span><span>Activa el GPS para continuar</span>'; ubicacionObtenida = false; },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        }
        
        document.getElementById('foto').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5*1024*1024) { alert('Foto muy grande. M√°ximo 5MB.'); this.value = ''; return; }
                const reader = new FileReader();
                reader.onload = function(e) { document.getElementById('photoPreview').src = e.target.result; document.getElementById('photoPreview').style.display = 'block'; document.querySelector('.photo-upload .icon').textContent = '‚úÖ'; document.querySelector('.photo-upload p').textContent = 'Foto lista'; fotoBase64 = e.target.result; document.getElementById('photoStatus').textContent = (file.size/1024).toFixed(1)+' KB'; }
                reader.readAsDataURL(file);
            }
        });
        
        document.getElementById('rutaCobroForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!ubicacionObtenida) { alert('Debes activar el GPS para enviar el registro'); obtenerUbicacion(); return; }
            if (!fotoBase64) { alert('Adjunta una foto'); return; }
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('btnSubmit').disabled = true;
            const ahora = new Date();
            const datos = { 
                asesor: NOMBRE_ASESOR, 
                empresa: document.getElementById('empresa').value, 
                observacion: document.getElementById('observacion').value, 
                horaReportada: ahora.toLocaleTimeString('es-CO'), 
                fechaReportada: ahora.toLocaleDateString('es-CO'), 
                contacto: document.getElementById('contacto').value, 
                timestampReal: ahora.getTime(), 
                fechaReal: ahora.toLocaleDateString('es-CO'), 
                horaReal: ahora.toLocaleTimeString('es-CO'), 
                latitud: latitud.toString(), 
                longitud: longitud.toString(), 
                precisionGPS: precisionGPS.toString(), 
                linkMapa: 'https://www.google.com/maps?q='+latitud+','+longitud, 
                foto: fotoBase64 
            };
            try { await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(datos) }); document.getElementById('loadingOverlay').style.display = 'none'; document.getElementById('formSection').style.display = 'none'; document.getElementById('successMessage').style.display = 'block'; }
            catch (error) { document.getElementById('loadingOverlay').style.display = 'none'; document.getElementById('btnSubmit').disabled = false; alert('Error al enviar'); }
        });
        
        function nuevoRegistro() { document.getElementById('rutaCobroForm').reset(); document.getElementById('photoPreview').style.display = 'none'; document.getElementById('photoStatus').textContent = ''; document.querySelector('.photo-upload .icon').textContent = 'üì∑'; document.querySelector('.photo-upload p').textContent = 'Toca para tomar foto'; document.getElementById('successMessage').style.display = 'none'; document.getElementById('formSection').style.display = 'block'; document.getElementById('btnSubmit').disabled = false; fotoBase64 = ''; inicializarFormulario(); }
        verificarDia();
    </script>
</body>
</html>
